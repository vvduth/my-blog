<!-- CKEditor 5 CDN Integration with Enhanced Markdown Support -->
<link
  rel="stylesheet"
  href="https://cdn.ckeditor.com/ckeditor5/47.2.0/ckeditor5.css"
/>
<script src="https://cdn.ckeditor.com/ckeditor5/47.2.0/ckeditor5.umd.js"></script>

<script>
  
const {
	ClassicEditor,
	Autosave,
	Essentials,
	Paragraph,
	Bold,
	Italic,
	Link,
	AutoLink,
	Fullscreen,
	Emoji,
	Mention,
	Autoformat,
	TextTransformation,
	MediaEmbed,
	Markdown,
	PasteFromMarkdownExperimental,
	Underline,
	Strikethrough,
	Code,
	Subscript,
	Superscript,
	FontBackgroundColor,
	FontColor,
	FontFamily,
	FontSize,
	Highlight,
	BlockQuote,
	HorizontalLine,
	CodeBlock,
	Indent,
	IndentBlock,
	Alignment,
	ImageInline,
	ImageToolbar,
	ImageBlock,
	ImageUpload,
	CloudServices,
	ImageInsertViaUrl,
	AutoImage,
	ImageStyle,
	LinkImage,
	ImageCaption,
	ImageTextAlternative,
	List,
	TodoList,
	HtmlComment,
	ShowBlocks,
	SourceEditing,
	GeneralHtmlSupport,
	Title
} = window.CKEDITOR;

  

  const LICENSE_KEY =
    "eyJhbGciOiJFUzI1NiJ9.eyJleHAiOjE3NjQzNzQzOTksImp0aSI6ImI4ZTgwMzIxLTMxZWYtNGI5ZS1hZWU1LWI5Zjk2M2Y1MGRiYyIsInVzYWdlRW5kcG9pbnQiOiJodHRwczovL3Byb3h5LWV2ZW50LmNrZWRpdG9yLmNvbSIsImRpc3RyaWJ1dGlvbkNoYW5uZWwiOlsiY2xvdWQiLCJkcnVwYWwiLCJzaCJdLCJ3aGl0ZUxhYmVsIjp0cnVlLCJsaWNlbnNlVHlwZSI6InRyaWFsIiwiZmVhdHVyZXMiOlsiKiJdLCJ2YyI6ImE2YTFkMGYwIn0.sOZiO4Ij9yIyqpTjxCwIhCRCKsYXzESX1amnDjQbfUn3z-MpJbgDty7QxaPujuTLZf7i4lnZz8dVTdJH3tt5kw";

  const editorConfig = {
    toolbar: {
      items: [
        "undo",
        "redo",
        "|",
        "sourceEditing",
        "showBlocks",
        "fullscreen",
        "|",
        "fontSize",
        "fontFamily",
        "fontColor",
        "fontBackgroundColor",
        "|",
        "bold",
        "italic",
        "underline",
        "strikethrough",
        "subscript",
        "superscript",
        "code",
        "|",
        "emoji",
        "horizontalLine",
        "link",
        "mediaEmbed",
        "highlight",
        "blockQuote",
        "codeBlock",
        "|",
        "alignment",
        "|",
        "bulletedList",
        "numberedList",
        "todoList",
        "outdent",
        "indent",
      ],
      shouldNotGroupWhenFull: false,
    },
    plugins: [
      Alignment,
      Autoformat,
      AutoImage,
      AutoLink,
      Autosave,
      BlockQuote,
      Bold,
      CloudServices,
      Code,
      CodeBlock,
      Emoji,
      Essentials,
      FontBackgroundColor,
      FontColor,
      FontFamily,
      FontSize,
      Fullscreen,
      GeneralHtmlSupport,
      Highlight,
      HorizontalLine,
      HtmlComment,
      ImageBlock,
      ImageCaption,
      ImageInline,
      ImageInsertViaUrl,
      ImageStyle,
      ImageTextAlternative,
      ImageToolbar,
      ImageUpload,
      Indent,
      IndentBlock,
      Italic,
      Link,
      LinkImage,
      List,
      Markdown,
      MediaEmbed,
      Mention,
      Paragraph,
      PasteFromMarkdownExperimental,
      ShowBlocks,
      SourceEditing,
      Strikethrough,
      Subscript,
      Superscript,
      TextTransformation,
      Title,
      TodoList,
      Underline,
    ],
    fontFamily: {
      supportAllValues: true,
    },
    fontSize: {
      options: [10, 12, 14, "default", 18, 20, 22],
      supportAllValues: true,
    },
    fullscreen: {
      onEnterCallback: (container) =>
        container.classList.add(
          "editor-container",
          "editor-container_classic-editor",
          "editor-container_include-fullscreen",
          "main-container"
        ),
    },
    htmlSupport: {
      allow: [
        {
          name: /^.*$/,
          styles: true,
          attributes: true,
          classes: true,
        },
      ],
    },
    image: {
      toolbar: [
        "toggleImageCaption",
        "imageTextAlternative",
        "|",
        "imageStyle:inline",
        "imageStyle:wrapText",
        "imageStyle:breakText",
      ],
    },
    initialData:'',
    licenseKey: LICENSE_KEY,
    link: {
      addTargetToExternalLinks: true,
      defaultProtocol: "https://",
      decorators: {
        toggleDownloadable: {
          mode: "manual",
          label: "Downloadable",
          attributes: {
            download: "file",
          },
        },
      },
    },
    mention: {
      feeds: [
        {
          marker: "@",
          feed: [
            /* See: https://ckeditor.com/docs/ckeditor5/latest/features/mentions.html */
          ],
        },
      ],
    },
    placeholder: "Type or paste your content here!",
  };

  document.addEventListener("DOMContentLoaded", function () {
    console.log("üöÄ CKEditor 5 Markdown-Ready Initialization Started");

    // ‚úÖ Initialize CKEditor 5 for post body (make-post.html)
    const bodyTextarea = document.querySelector("#body");
    if (bodyTextarea) {
      console.log(
        "üìù Found body textarea, initializing full-featured editor..."
      );
      bodyTextarea.removeAttribute("required");

      ClassicEditor.create(bodyTextarea, editorConfig)
        .then((editor) => {
          window.bodyEditor = editor;
          console.log(
            "‚úÖ Full-featured editor initialized with Markdown paste support"
          );
          
          // üé® Apply Cyberpunk Styling
          

          // ‚ö° Form Submission Handler
          const form = bodyTextarea.closest("form");
          const bodyError = document.getElementById("bodyError");
          const submitBtn = form ? form.querySelector('[type="submit"]') : null;

          if (form) {
            form.addEventListener("submit", function (e) {
              e.preventDefault();
              console.log("üì§ Form submission initiated");

              // Loading state
              if (submitBtn) {
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.dataset.originalText = originalText;
                submitBtn.innerHTML =
                  '<span class="spinner-border spinner-border-sm me-2"></span>Publishing...';
              }

              // Transfer CKEditor content to textarea
              const content = editor.getData();
              bodyTextarea.value = content;

              // Validation
              const textContent = content.replace(/<[^>]*>/g, "").trim();

              if (!textContent || textContent.length === 0) {
                if (bodyError) bodyError.style.display = "block";
                showCyberAlert("ERROR: Post content cannot be empty!");

                // Reset button state
                if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.textContent =
                    submitBtn.dataset.originalText || "Submit Post";
                }

                if (editorElement) {
                  editorElement.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                  });
                  editorElement.focus();
                }
                return false;
              }

              // Hide error if validation passes
              if (bodyError) bodyError.style.display = "none";

              console.log("‚úÖ Validation passed, submitting form");
              // Submit using prototype to bypass form field name conflicts
              HTMLFormElement.prototype.submit.call(form);
            });
          }

          // üí° Add Markdown paste hint
          console.log(
            "üí° TIP: You can now paste Markdown directly into the editor!"
          );
          console.log(
            "   Try pasting: **bold** *italic* `code` or fenced code blocks"
          );
        })
        .catch((error) => {
          console.error("‚ùå CKEditor 5 initialization error:", error);
        });
    } else {
      console.log("‚ÑπÔ∏è  Body textarea not found (not on post creation page)");
    }

    // ‚úÖ Initialize simplified editor for comments (post.html)
    const commentTextarea = document.querySelector("#comment_text");
    if (commentTextarea) {
      console.log(
        "üí¨ Found comment textarea, initializing lightweight editor..."
      );
      commentTextarea.removeAttribute("required");

      ClassicEditor.create(commentTextarea, {
        licenseKey:
          "eyJhbGciOiJFUzI1NiJ9.eyJleHAiOjE3NjQzNzQzOTksImp0aSI6ImI4ZTgwMzIxLTMxZWYtNGI5ZS1hZWU1LWI5Zjk2M2Y1MGRiYyIsInVzYWdlRW5kcG9pbnQiOiJodHRwczovL3Byb3h5LWV2ZW50LmNrZWRpdG9yLmNvbSIsImRpc3RyaWJ1dGlvbkNoYW5uZWwiOlsiY2xvdWQiLCJkcnVwYWwiLCJzaCJdLCJ3aGl0ZUxhYmVsIjp0cnVlLCJsaWNlbnNlVHlwZSI6InRyaWFsIiwiZmVhdHVyZXMiOlsiKiJdLCJ2YyI6ImE2YTFkMGYwIn0.sOZiO4Ij9yIyqpTjxCwIhCRCKsYXzESX1amnDjQbfUn3z-MpJbgDty7QxaPujuTLZf7i4lnZz8dVTdJH3tt5kw",

        plugins: [
          Essentials,
          Paragraph,
          Bold,
          Italic,
          Code,
          Link,
          List,
          BlockQuote,
          PasteFromMarkdownExperimental, // ‚úÖ Markdown paste for comments too
        ],

        toolbar: [
          "bold",
          "italic",
          "code",
          "link",
          "bulletedList",
          "numberedList",
          "blockQuote",
        ],

        link: {
          addTargetToExternalLinks: true,
          defaultProtocol: "https://",
        },
      })
        .then((editor) => {
          window.commentEditor = editor;
          console.log("‚úÖ Comment editor initialized with Markdown paste");

          // Cyberpunk styling
          const editorElement = editor.ui.view.editable.element;
          if (editorElement) {
            editorElement.style.backgroundColor = "rgba(13, 17, 23, 0.8)";
            editorElement.style.color = "#00ffff";
            editorElement.style.border = "2px solid var(--cyber-neon-cyan)";
            editorElement.style.minHeight = "150px";
            editorElement.style.transition = "border-color 0.3s ease";
            editorElement.style.padding = "1rem";

            editorElement.addEventListener("focus", () => {
              editorElement.style.borderColor = "var(--cyber-neon-pink)";
            });
            editorElement.addEventListener("blur", () => {
              editorElement.style.borderColor = "var(--cyber-neon-cyan)";
            });
          }

          // Form submission
          const form = commentTextarea.closest("form");
          const submitBtn = form ? form.querySelector('[type="submit"]') : null;

          if (form) {
            form.addEventListener("submit", function (e) {
              e.preventDefault();
              console.log("üí¨ Comment submission initiated");

              if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML =
                  '<span class="spinner-border spinner-border-sm me-2"></span>Posting...';
              }

              const content = editor.getData();
              commentTextarea.value = content;

              const textContent = content.replace(/<[^>]*>/g, "").trim();
              if (!textContent || textContent.length === 0) {
                showCyberAlert("ERROR: Comment cannot be empty!");

                if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.textContent = "Submit Comment";
                }

                if (editorElement) {
                  editorElement.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                  });
                  editorElement.focus();
                }
                return false;
              }

              console.log("‚úÖ Comment validation passed, submitting");
              HTMLFormElement.prototype.submit.call(form);
            });
          }
        })
        .catch((error) => {
          console.error("‚ùå Comment editor initialization error:", error);
          commentTextarea.style.display = "block";
          commentTextarea.style.backgroundColor = "rgba(13, 17, 23, 0.8)";
          commentTextarea.style.color = "#00ffff";
          commentTextarea.style.border = "2px solid var(--cyber-neon-cyan)";
          commentTextarea.style.padding = "0.75rem";
          commentTextarea.style.fontFamily = "'Courier New', monospace";
          commentTextarea.classList.add("form-control");
        });
    } else {
      console.log("‚ÑπÔ∏è  Comment textarea not found (not on post detail page)");
    }
  });

  // üé® Enhanced Cyberpunk Alert with Animation
  function showCyberAlert(message) {
    const overlay = document.createElement("div");
    overlay.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; animation: fadeIn 0.3s ease;
    `;

    const alertBox = document.createElement("div");
    alertBox.style.cssText = `
      background: linear-gradient(135deg, rgba(13, 17, 23, 0.95), rgba(20, 25, 35, 0.95));
      border: 2px solid #ff006e;
      padding: 2rem;
      border-radius: 12px;
      max-width: 450px;
      text-align: center;
      box-shadow: 0 0 40px rgba(255, 0, 110, 0.6), 0 0 80px rgba(255, 0, 110, 0.3);
      animation: slideDown 0.3s ease, pulse 2s ease-in-out infinite;
    `;

    alertBox.innerHTML = `
      <div style="color: #ff006e; font-family: 'Courier New', monospace; font-size: 1.3rem; margin-bottom: 1rem; text-shadow: 0 0 15px rgba(255, 0, 110, 0.7); font-weight: bold;">
        ‚ö† SYSTEM ALERT
      </div>
      <div style="color: #00ffff; font-family: 'Courier New', monospace; margin-bottom: 1.5rem; line-height: 1.6; font-size: 1rem;">
        ${message}
      </div>
      <button onclick="this.closest('[style*=fixed]').remove()"
              style="background: linear-gradient(135deg, #ff006e, #8b00ff);
                     color: white; border: none; padding: 0.75rem 2rem;
                     border-radius: 6px; cursor: pointer;
                     font-family: 'Courier New', monospace; font-weight: bold;
                     transition: all 0.3s ease;
                     box-shadow: 0 4px 15px rgba(255, 0, 110, 0.4);
                     text-transform: uppercase; letter-spacing: 1px;"
              onmouseover="this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 6px 25px rgba(255, 0, 110, 0.7)';"
              onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(255, 0, 110, 0.4)';">
        [ Acknowledge ]
      </button>
    `;

    overlay.appendChild(alertBox);
    document.body.appendChild(overlay);

    // Enhanced animations
    const style = document.createElement("style");
    style.textContent = `
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideDown {
        from { transform: translateY(-60px) scale(0.9); opacity: 0; }
        to { transform: translateY(0) scale(1); opacity: 1; }
      }
      @keyframes pulse {
        0%, 100% {
          box-shadow: 0 0 40px rgba(255, 0, 110, 0.6), 0 0 80px rgba(255, 0, 110, 0.3);
          border-color: #ff006e;
        }
        50% {
          box-shadow: 0 0 50px rgba(255, 0, 110, 0.8), 0 0 100px rgba(255, 0, 110, 0.5);
          border-color: #ff0080;
        }
      }
    `;
    document.head.appendChild(style);
  }
</script>

<style>
</style>
